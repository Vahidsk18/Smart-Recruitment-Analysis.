{% extends 'base.html' %}
{% load core_filters %}

{% block title %}Applications for {{ job.job_role }}{% endblock %}

{% block content %}
    <h2 class="mb-4">Applications for "{{ job.job_role }}" at {{ job.company_name }}</h2>
    <p class="lead">Total Applications: <span class="badge bg-primary fs-5">{{ all_applications_count }}</span></p>

    {# Filter Applications Card #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Applications</h5>
            <button class="btn btn-sm btn-outline-light d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
                Toggle Filters
            </button>
        </div>
        <div class="card-body collapse show" id="filterCollapse">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="min_cgpa" class="form-label">Min CGPA:</label>
                    <input type="number" step="0.01" name="min_cgpa" id="min_cgpa" class="form-control" value="{{ current_min_cgpa|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label for="branch" class="form-label">Branch:</label>
                    <select name="branch" id="branch" class="form-select">
                        <option value="">All Branches</option>
                        {% for b in available_branches %}
                            <option value="{{ b }}" {% if b == current_branch %}selected{% endif %}>{{ b }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="max_backlogs" class="form-label">Max Backlogs:</label>
                    <input type="number" name="max_backlogs" id="max_backlogs" class="form-control" value="{{ current_max_backlogs|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label for="skills" class="form-label">Skills (comma-separated):</label>
                    <input type="text" name="skills" id="skills" class="form-control" value="{{ current_skills|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status:</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">All Statuses</option>
                        {% for s_value, s_display in Application.APPLICATION_STATUS_CHOICES %}
                            <option value="{{ s_value }}" {% if s_value == current_status %}selected{% endif %}>{{ s_display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-auto d-flex gap-2">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Search</button>
                    <a href="{% url 'applications_for_job' job.id %}" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Clear</a>
                </div>
            </form>
        </div>
    </div>

    {# Applications List Table #}
    {% if applications %}
        <div class="table-responsive">
            <table class="table table-striped table-hover shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Student Name</th>
                        <th>Roll No.</th>
                        <th>Branch</th>
                        <th>CGPA</th>
                        <th>Backlogs</th>
                        <th>Skills</th>
                        <th>Contact</th>
                        <th>Applied At</th>
                        <th>Actions</th>
                        <th>Review Application</th>
                    </tr>
                </thead>
                <tbody>
                    {% for app in applications %}
                        <tr>
                            <td>
                                {# Link student name to their profile view #}
                                <a href="{% url 'student_profile_view' %}" class="text-decoration-none fw-bold">{{ app.student.user.first_name }} {{ app.student.user.last_name }}</a>
                                <br><small class="text-muted">({{ app.student.user.username }})</small>
                            </td>
                            <td>{{ app.student.roll_number }}</td>
                            <td>{{ app.student.branch }}</td>
                            <td>{{ app.student.cgpa|default:"N/A" }}</td>
                            <td>{{ app.student.backlogs }}</td>
                            <td class="text-wrap" style="max-width: 150px;">{{ app.student.skills|default:"-" }}</td>
                            <td>{{ app.student.phone_number|default:"N/A" }}</td>
                            <td>{{ app.applied_at|date:"M d, Y H:i" }}</td>
                            <td>
                                <div class="d-flex flex-column gap-2">
                                    {% if app.student.resume_file %}
                                        <a href="{{ app.student.resume_file.url }}" target="_blank" class="btn btn-sm btn-outline-info" title="View Resume"><i class="bi bi-file-earmark-text"></i> View Resume</a>
                                    {% else %}
                                        <button class="btn btn-sm btn-outline-secondary" disabled><i class="bi bi-file-earmark-text"></i> No Resume</button>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <form method="post" action="{% url 'update_application_status' app.id %}" class="d-flex flex-column align-items-start gap-1" id="app-form-{{ app.id }}">
                                    {% csrf_token %}
                                    {# Hidden input for status to ensure value is sent reliably #}
                                    <input type="hidden" name="status" id="hidden_status_{{ app.id }}" value="{{ app.status }}">
                                    {# Hidden input for admin_comments #}
                                    <input type="hidden" name="admin_comments" id="hidden_admin_comments_{{ app.id }}" value="{{ app.admin_comments|default:"" }}">

                                    <div class="w-100">
                                        {# Display dropdown for visual representation, not for direct form submission #}
                                        <select onchange="document.getElementById('hidden_status_{{ app.id }}').value = this.value;" class="form-select form-select-sm">
                                            {% for s_value, s_display in Application.APPLICATION_STATUS_CHOICES %}
                                                <option value="{{ s_value }}" {% if app.status == s_value %}selected{% endif %}>{{ s_display }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="w-100">
                                        <textarea onkeyup="document.getElementById('hidden_admin_comments_{{ app.id }}').value = this.value;" class="form-control form-control-sm" placeholder="Add comments...">{{ app.admin_comments|default:"" }}</textarea>
                                    </div>
                                    <div class="d-flex gap-2 mt-2 w-100">
                                        <button type="button" class="btn btn-sm btn-success flex-fill" onclick="setHiddenStatusAndSubmit('{{ app.id }}', 'accepted', 'Accepted by admin.')">
                                            <i class="bi bi-check-circle"></i> Accept
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger flex-fill" onclick="setHiddenStatusAndSubmit('{{ app.id }}', 'rejected', 'Rejected by admin.')">
                                            <i class="bi bi-x-circle"></i> Reject
                                        </button>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary mt-2 w-100"><i class="bi bi-save"></i> Update Status</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            No applications found for this job with the current filters.
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    function setHiddenStatusAndSubmit(appId, status, comment) {
        document.getElementById(`hidden_status_${appId}`).value = status;
        const commentField = document.getElementById(`hidden_admin_comments_${appId}`);
        if (!commentField.value) { // Only set default comment if it's empty
            commentField.value = comment;
        }
        document.getElementById(`app-form-${appId}`).submit();
    }
</script>
{% endblock %}